<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Sanctification">
    <meta name="theme-color" content="#4F46E5">
    <title>Path to Sanctification - Catholic Spiritual Tracker</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%234F46E5' width='100' height='100'/><text y='70' font-size='70' fill='white' text-anchor='middle' x='50'>‚úù</text></svg>">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%234F46E5' width='100' height='100'/><text y='70' font-size='70' fill='white' text-anchor='middle' x='50'>‚úù</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .confession-item { 
            transition: all 0.2s;
        }
        .confession-item:hover {
            background-color: #f3f4f6;
        }
        
        /* Mobile optimizations */
        * {
            -webkit-tap-highlight-color: transparent;
        }
        
        input[type="checkbox"] {
            min-width: 20px;
            min-height: 20px;
        }
        
        @media (max-width: 768px) {
            .tab-btn {
                font-size: 0.875rem;
                padding: 1rem 0.75rem;
            }
        }
        
        /* Better touch targets */
        label {
            cursor: pointer;
            -webkit-user-select: none;
            user-select: none;
        }
        
        /* Smooth scrolling */
        html {
            scroll-behavior: smooth;
        }
        
        /* Safe area for iPhone notch */
        body {
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    
    <!-- Security PIN Setup/Login Screen - DISABLED -->
    <div id="security-screen" class="fixed inset-0 bg-indigo-900 z-50 flex items-center justify-center" style="display: none !important;">
        <div class="bg-white rounded-lg shadow-2xl p-8 max-w-md w-full mx-4">
            <div class="text-center mb-6">
                <div class="text-6xl mb-4">‚úùÔ∏è</div>
                <h2 class="text-2xl font-bold text-gray-800" id="security-title">Secure Your Spiritual Journey</h2>
                <p class="text-gray-600 mt-2" id="security-subtitle">Create a PIN to protect your data</p>
            </div>
            
            <div id="pin-setup" style="display: none;">
                <div class="mb-6">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Create 4-6 Digit PIN</label>
                    <input type="password" id="new-pin" inputmode="numeric" pattern="[0-9]*" maxlength="6"
                           class="w-full px-4 py-3 border border-gray-300 rounded-md text-center text-2xl tracking-widest"
                           placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    <p class="text-xs text-gray-500 mt-2">This PIN will protect your confession records and spiritual data</p>
                </div>
                <div class="mb-6">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Confirm PIN</label>
                    <input type="password" id="confirm-pin" inputmode="numeric" pattern="[0-9]*" maxlength="6"
                           class="w-full px-4 py-3 border border-gray-300 rounded-md text-center text-2xl tracking-widest"
                           placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>
                <button onclick="setupPIN()" class="w-full bg-indigo-600 text-white py-3 rounded-md font-semibold hover:bg-indigo-700 transition">
                    Set PIN & Continue
                </button>
                <p id="pin-setup-error" class="text-red-600 text-sm mt-2 text-center"></p>
            </div>
            
            <div id="pin-login" style="display: none;">
                <div class="mb-6">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Enter Your PIN</label>
                    <input type="password" id="login-pin" inputmode="numeric" pattern="[0-9]*" maxlength="6"
                           class="w-full px-4 py-3 border border-gray-300 rounded-md text-center text-2xl tracking-widest"
                           placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>
                <button onclick="loginWithPIN()" class="w-full bg-indigo-600 text-white py-3 rounded-md font-semibold hover:bg-indigo-700 transition mb-3">
                    Unlock
                </button>
                <button onclick="tryBiometric()" id="biometric-btn" class="w-full bg-gray-200 text-gray-700 py-3 rounded-md font-semibold hover:bg-gray-300 transition" style="display: none;">
                    üîê Use Face ID / Touch ID
                </button>
                <p id="pin-login-error" class="text-red-600 text-sm mt-2 text-center"></p>
            </div>
        </div>
    </div>

    <!-- Session Timeout Overlay - DISABLED -->
    <div id="timeout-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 flex items-center justify-center" style="display: none !important;">
        <div class="bg-white rounded-lg shadow-2xl p-8 max-w-sm w-full mx-4">
            <div class="text-center mb-4">
                <div class="text-4xl mb-2">üîí</div>
                <h3 class="text-xl font-bold text-gray-800">Session Locked</h3>
                <p class="text-gray-600 mt-2">For your security, please enter your PIN</p>
            </div>
            <div class="mb-4">
                <input type="password" id="timeout-pin" inputmode="numeric" pattern="[0-9]*" maxlength="6"
                       class="w-full px-4 py-3 border border-gray-300 rounded-md text-center text-2xl tracking-widest"
                       placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            </div>
            <button onclick="unlockFromTimeout()" class="w-full bg-indigo-600 text-white py-3 rounded-md font-semibold hover:bg-indigo-700 transition">
                Unlock
            </button>
            <p id="timeout-error" class="text-red-600 text-sm mt-2 text-center"></p>
        </div>
    </div>

    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h1 class="text-3xl font-bold text-indigo-900 text-center mb-2">‚úù Path to Sanctification</h1>
            <p class="text-center text-gray-600">Your Journey from Sinner to Saint</p>
        </div>

        <!-- Navigation Tabs -->
        <div class="bg-white rounded-lg shadow-lg mb-6">
            <div class="flex flex-wrap border-b border-gray-200">
                <button onclick="switchTab('daily')" class="tab-btn px-6 py-4 font-semibold text-gray-700 border-b-2 border-indigo-600">
                    Daily Activities
                </button>
                <button onclick="switchTab('readings')" class="tab-btn px-6 py-4 font-semibold text-gray-500 hover:text-gray-700 border-b-2 border-transparent">
                    Daily Readings
                </button>
                <button onclick="switchTab('confession')" class="tab-btn px-6 py-4 font-semibold text-gray-500 hover:text-gray-700 border-b-2 border-transparent">
                    Confession
                </button>
                <button onclick="switchTab('confession-tracker')" class="tab-btn px-6 py-4 font-semibold text-gray-500 hover:text-gray-700 border-b-2 border-transparent">
                    Sin Tracker
                </button>
                <button onclick="switchTab('mercy')" class="tab-btn px-6 py-4 font-semibold text-gray-500 hover:text-gray-700 border-b-2 border-transparent">
                    Works of Mercy
                </button>
                <button onclick="switchTab('history')" class="tab-btn px-6 py-4 font-semibold text-gray-500 hover:text-gray-700 border-b-2 border-transparent">
                    History
                </button>
                <button onclick="switchTab('progress')" class="tab-btn px-6 py-4 font-semibold text-gray-500 hover:text-gray-700 border-b-2 border-transparent">
                    Progress
                </button>
                <button onclick="switchTab('data')" class="tab-btn px-6 py-4 font-semibold text-gray-500 hover:text-gray-700 border-b-2 border-transparent">
                    Data
                </button>
            </div>

            <!-- Daily Activities Tab -->
            <div id="daily-tab" class="tab-content active p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Today's Spiritual Activities</h2>
                <p class="text-sm text-gray-500 mb-6" id="today-date"></p>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-gradient-to-r from-rose-50 to-pink-50 p-4 rounded-lg border border-rose-200">
                        <label class="flex items-center space-x-3 cursor-pointer">
                            <input type="checkbox" class="w-5 h-5 text-rose-600 rounded" onchange="saveDailyActivity('rosary')">
                            <span class="font-semibold text-gray-700">üåπ Holy Rosary</span>
                        </label>
                    </div>
                    
                    <div class="bg-gradient-to-r from-amber-50 to-yellow-50 p-4 rounded-lg border border-amber-200">
                        <label class="flex items-center space-x-3 cursor-pointer">
                            <input type="checkbox" class="w-5 h-5 text-amber-600 rounded" onchange="saveDailyActivity('mass')">
                            <span class="font-semibold text-gray-700">‚õ™ Holy Mass</span>
                        </label>
                    </div>
                    
                    <div class="bg-gradient-to-r from-blue-50 to-cyan-50 p-4 rounded-lg border border-blue-200">
                        <label class="flex items-center space-x-3 cursor-pointer">
                            <input type="checkbox" class="w-5 h-5 text-blue-600 rounded" onchange="saveDailyActivity('bible')">
                            <span class="font-semibold text-gray-700">üìñ Bible Reading</span>
                        </label>
                        <input type="number" min="0" placeholder="Minutes" 
                               class="mt-2 w-full px-3 py-2 border border-blue-300 rounded-md text-sm"
                               onchange="saveDailyActivityMinutes('bible', this.value)">
                    </div>
                    
                    <div class="bg-gradient-to-r from-purple-50 to-violet-50 p-4 rounded-lg border border-purple-200">
                        <label class="flex items-center space-x-3 cursor-pointer">
                            <input type="checkbox" class="w-5 h-5 text-purple-600 rounded" onchange="saveDailyActivity('adoration')">
                            <span class="font-semibold text-gray-700">üïØÔ∏è Eucharistic Adoration</span>
                        </label>
                        <input type="number" min="0" placeholder="Minutes" 
                               class="mt-2 w-full px-3 py-2 border border-purple-300 rounded-md text-sm"
                               onchange="saveDailyActivityMinutes('adoration', this.value)">
                    </div>
                    
                    <div class="bg-gradient-to-r from-green-50 to-emerald-50 p-4 rounded-lg border border-green-200">
                        <label class="flex items-center space-x-3 cursor-pointer">
                            <input type="checkbox" class="w-5 h-5 text-green-600 rounded" onchange="saveDailyActivity('divine-office')">
                            <span class="font-semibold text-gray-700">üìø Divine Office/Liturgy of Hours</span>
                        </label>
                    </div>
                    
                    <div class="bg-gradient-to-r from-indigo-50 to-blue-50 p-4 rounded-lg border border-indigo-200">
                        <label class="flex items-center space-x-3 cursor-pointer">
                            <input type="checkbox" class="w-5 h-5 text-indigo-600 rounded" onchange="saveDailyActivity('divine-mercy')">
                            <span class="font-semibold text-gray-700">üôè Divine Mercy Chaplet</span>
                        </label>
                    </div>
                    
                    <div class="bg-gradient-to-r from-orange-50 to-red-50 p-4 rounded-lg border border-orange-200">
                        <label class="flex items-center space-x-3 cursor-pointer">
                            <input type="checkbox" class="w-5 h-5 text-orange-600 rounded" onchange="saveDailyActivity('spiritual-reading')">
                            <span class="font-semibold text-gray-700">üìö Spiritual Reading</span>
                        </label>
                        <input type="number" min="0" placeholder="Minutes" 
                               class="mt-2 w-full px-3 py-2 border border-orange-300 rounded-md text-sm"
                               onchange="saveDailyActivityMinutes('spiritual-reading', this.value)">
                    </div>
                    
                    <div class="bg-gradient-to-r from-teal-50 to-cyan-50 p-4 rounded-lg border border-teal-200">
                        <label class="flex items-center space-x-3 cursor-pointer">
                            <input type="checkbox" class="w-5 h-5 text-teal-600 rounded" onchange="saveDailyActivity('meditation')">
                            <span class="font-semibold text-gray-700">üßò Mental Prayer/Meditation</span>
                        </label>
                        <input type="number" min="0" placeholder="Minutes" 
                               class="mt-2 w-full px-3 py-2 border border-teal-300 rounded-md text-sm"
                               onchange="saveDailyActivityMinutes('meditation', this.value)">
                    </div>
                    
                    <div class="bg-gradient-to-r from-gray-50 to-slate-50 p-4 rounded-lg border border-gray-200">
                        <label class="flex items-center space-x-3 cursor-pointer">
                            <input type="checkbox" class="w-5 h-5 text-gray-600 rounded" onchange="saveDailyActivity('fasting')">
                            <span class="font-semibold text-gray-700">üçû Fasting/Abstinence</span>
                        </label>
                    </div>
                    
                    <div class="bg-gradient-to-r from-pink-50 to-rose-50 p-4 rounded-lg border border-pink-200">
                        <label class="flex items-center space-x-3 cursor-pointer">
                            <input type="checkbox" class="w-5 h-5 text-pink-600 rounded" onchange="saveDailyActivity('examination')">
                            <span class="font-semibold text-gray-700">üîç Examination of Conscience</span>
                        </label>
                    </div>
                </div>

                <div class="mt-6 bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <h3 class="font-semibold text-blue-900 mb-2">Notes for Today</h3>
                    <textarea id="daily-notes" rows="3" 
                              class="w-full px-3 py-2 border border-blue-300 rounded-md"
                              placeholder="Spiritual insights, graces received, challenges encountered..."
                              onchange="saveDailyNotes()"></textarea>
                </div>

                <div class="mt-6 bg-gray-50 border border-gray-300 rounded-lg p-4">
                    <div class="mt-4 pt-4">
                        <h3 class="font-semibold text-gray-700 mb-2">Reset Everything</h3>
                        <button onclick="resetPINManually()" class="w-full bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 text-sm">
                            üóëÔ∏è Clear All Data & Reset
                        </button>
                        <p class="text-xs text-gray-500 mt-2">Deletes everything and starts fresh</p>
                    </div>
                </div>
            </div>

            <!-- Daily Readings Tab -->
            <div id="readings-tab" class="tab-content p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Today's Mass Readings</h2>
                <p class="text-sm text-gray-500 mb-6" id="readings-date"></p>
                
                <div id="readings-loading" class="text-center py-8">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div>
                    <p class="text-gray-600 mt-4">Loading today's readings...</p>
                </div>
                
                <div id="readings-error" style="display: none;" class="bg-red-50 border border-red-200 rounded-lg p-6">
                    <p class="text-red-800 font-semibold">Unable to load readings</p>
                    <p class="text-red-600 text-sm mt-2">Please check your internet connection or visit <a href="https://bible.usccb.org/daily-bible-reading" class="underline" target="_blank">USCCB Daily Readings</a></p>
                </div>
                
                <div id="readings-content" style="display: none;" class="space-y-6">
                    <!-- Will be populated dynamically -->
                </div>
            </div>

            <!-- Confession Tab -->
            <div id="confession-tab" class="tab-content p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Sacrament of Reconciliation</h2>
                
                <div class="bg-purple-50 border border-purple-200 rounded-lg p-4 mb-6">
                    <p class="text-sm text-purple-900 mb-2">
                        <strong>Last Confession:</strong> <span id="last-confession-date">Never recorded</span>
                    </p>
                    <button onclick="recordNewConfession()" 
                            class="bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700 transition">
                        Prepare for Confession
                    </button>
                </div>

                <div id="confession-form" style="display: none;" class="mb-6 bg-gray-50 border border-gray-200 rounded-lg p-6">
                    
                    <!-- Confession Process Guide -->
                    <div class="bg-gradient-to-r from-purple-50 to-indigo-50 border border-purple-200 rounded-lg p-6 mb-6">
                        <h3 class="text-lg font-semibold text-purple-900 mb-4">üôè Steps for a Good Confession</h3>
                        <div class="text-gray-700 space-y-3 text-sm">
                            <div class="flex gap-3">
                                <span class="font-bold text-purple-700 min-w-[24px]">1.</span>
                                <span><strong>Sign of the Cross</strong></span>
                            </div>
                            <div class="flex gap-3">
                                <span class="font-bold text-purple-700 min-w-[24px]">2.</span>
                                <span><strong>Greeting:</strong> "Bless me, Father, for I have sinned. My last confession was..." (weeks, months, years)</span>
                            </div>
                            <div class="flex gap-3">
                                <span class="font-bold text-purple-700 min-w-[24px]">3.</span>
                                <span><strong>Confess your sins</strong> to the priest (use examination below)</span>
                            </div>
                            <div class="flex gap-3">
                                <span class="font-bold text-purple-700 min-w-[24px]">4.</span>
                                <span><strong>Conclude:</strong> "This is all I can remember. I am sorry for these and all my sins."</span>
                            </div>
                            <div class="flex gap-3">
                                <span class="font-bold text-purple-700 min-w-[24px]">5.</span>
                                <span><strong>Receive penance</strong> from the priest</span>
                            </div>
                            <div class="flex gap-3">
                                <span class="font-bold text-purple-700 min-w-[24px]">6.</span>
                                <div>
                                    <span><strong>Pray Act of Contrition:</strong></span>
                                    <div class="mt-2 pl-4 italic text-gray-600 border-l-2 border-purple-300">
                                        <p>My God,<br>
                                        I am sorry for my sins with all my heart.<br>
                                        In choosing to do wrong<br>
                                        and failing to do good,<br>
                                        I have sinned against you<br>
                                        whom I should love above all things.<br>
                                        I firmly intend, with your help,<br>
                                        to do penance,<br>
                                        to sin no more,<br>
                                        and to avoid whatever leads me to sin.<br>
                                        Our Savior Jesus Christ<br>
                                        suffered and died for us.<br>
                                        In his name, my God, have mercy.</p>
                                    </div>
                                </div>
                            </div>
                            <div class="flex gap-3">
                                <span class="font-bold text-purple-700 min-w-[24px]">7.</span>
                                <span><strong>Receive Absolution</strong> from the priest</span>
                            </div>
                            <div class="flex gap-3">
                                <span class="font-bold text-purple-700 min-w-[24px]">8.</span>
                                <span><strong>Sign of the Cross</strong> and respond "Amen"</span>
                            </div>
                            <div class="flex gap-3">
                                <span class="font-bold text-purple-700 min-w-[24px]">9.</span>
                                <span><strong>Receive blessing</strong> from the priest</span>
                            </div>
                            <div class="flex gap-3">
                                <span class="font-bold text-purple-700 min-w-[24px]">10.</span>
                                <span><strong>Complete your penance</strong></span>
                            </div>
                        </div>
                    </div>
                    
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Examination of Conscience</h3>
                    
                    <!-- Sins Against God (1st, 2nd, 3rd Commandments) -->
                    <div class="mb-6">
                        <h4 class="font-bold text-gray-700 mb-3 text-lg border-b pb-2">Sins Against God</h4>
                        <div class="space-y-2">
                            <label class="flex items-start space-x-3 confession-item p-2 rounded">
                                <input type="checkbox" class="mt-1 w-4 h-4 text-red-600 rounded" data-sin="idolatry">
                                <span class="text-sm"><strong>Idolatry</strong> - Placing other things before God (money, success, pleasure)</span>
                            </label>
                            <label class="flex items-start space-x-3 confession-item p-2 rounded">
                                <input type="checkbox" class="mt-1 w-4 h-4 text-red-600 rounded" data-sin="superstition">
                                <span class="text-sm"><strong>Superstition</strong> - Fortune telling, horoscopes, occult practices</span>
                            </label>
                            <label class="flex items-start space-x-3 confession-item p-2 rounded">
                                <input type="checkbox" class="mt-1 w-4 h-4 text-red-600 rounded" data-sin="blasphemy">
                                <span class="text-sm"><strong>Blasphemy</strong> - Speaking against God, sacred things, or the Church</span>
                            </label>
                            <label class="flex items-start space-x-3 confession-item p-2 rounded">
                                <input type="checkbox" class="mt-1 w-4 h-4 text-red-600 rounded" data-sin="taking-lords-name">
                                <span class="text-sm"><strong>Taking the Lord's Name in Vain</strong> - Misusing God's name</span>
                            </label>
                            <label class="flex items-start space-x-3 confession-item p-2 rounded">
                                <input type="checkbox" class="mt-1 w-4 h-4 text-red-600 rounded" data-sin="missing-mass">
                                <span class="text-sm"><strong>Missing Mass</strong> - Deliberately missing Sunday/Holy Day Mass without serious reason</span>
                            </label>
                            <label class="flex items-start space-x-3 confession-item p-2 rounded">
                                <input type="checkbox" class="mt-1 w-4 h-4 text-red-600 rounded" data-sin="unnecessary-work-sunday">
                                <span class="text-sm"><strong>Unnecessary Work on Sunday</strong> - Not keeping the Lord's Day holy</span>
                            </label>
                        </div>
                    </div>

                    <!-- Sins Against Neighbor (4th-10th Commandments) -->
                    <div class="mb-6">
                        <h4 class="font-bold text-gray-700 mb-3 text-lg border-b pb-2">Sins Against Neighbor</h4>
                        <div class="space-y-2">
                            <label class="flex items-start space-x-3 confession-item p-2 rounded">
                                <input type="checkbox" class="mt-1 w-4 h-4 text-red-600 rounded" data-sin="disobedience-parents">
                                <span class="text-sm"><strong>Disobedience to Parents/Authority</strong> - Disrespecting legitimate authority</span>
                            </label>
                            <label class="flex items-start space-x-3 confession-item p-2 rounded">
                                <input type="checkbox" class="mt-1 w-4 h-4 text-red-600 rounded" data-sin="hatred">
                                <span class="text-sm"><strong>Hatred/Resentment</strong> - Harboring ill will toward others</span>
                            </label>
                            <label class="flex items-start space-x-3 confession-item p-2 rounded">
                                <input type="checkbox" class="mt-1 w-4 h-4 text-red-600 rounded" data-sin="anger">
                                <span class="text-sm"><strong>Anger/Wrath</strong> - Uncontrolled anger, seeking revenge</span>
                            </label>
                            <label class="flex items-start space-x-3 confession-item p-2 rounded">
                                <input type="checkbox" class="mt-1 w-4 h-4 text-red-600 rounded" data-sin="violence">
                                <span class="text-sm"><strong>Violence</strong> - Physical harm to others</span>
                            </label>
                            <label class="flex items-start space-x-3 confession-item p-2 rounded">
                                <input type="checkbox" class="mt-1 w-4 h-4 text-red-600 rounded" data-sin="abortion">
                                <span class="text-sm"><strong>Abortion/Cooperation in Abortion</strong> - Direct or indirect participation</span>
                            </label>
                            <label class="flex items-start space-x-3 confession-item p-2 rounded">
                                <input type="checkbox" class="mt-1 w-4 h-4 text-red-600 rounded" data-sin="scandal">
                                <span class="text-sm"><strong>Scandal</strong> - Leading others into sin by word or example</span>
                            </label>
                            <label class="flex items-start space-x-3 confession-item p-2 rounded">
                                <input type="checkbox" class="mt-1 w-4 h-4 text-red-600 rounded" data-sin="lying">
                                <span class="text-sm"><strong>Lying</strong> - Deliberate falsehood</span>
                            </label>
                            <label class="flex items-start space-x-3 confession-item p-2 rounded">
                                <input type="checkbox" class="mt-1 w-4 h-4 text-red-600 rounded" data-sin="calumny">
                                <span class="text-sm"><strong>Calumny/Slander</strong> - False statements harming another's reputation</span>
                            </label>
                            <label class="flex items-start space-x-3 confession-item p-2 rounded">
                                <input type="checkbox" class="mt-1 w-4 h-4 text-red-600 rounded" data-sin="detraction">
                                <span class="text-sm"><strong>Detraction</strong> - Revealing another's faults without valid reason</span>
                            </label>
                            <label class="flex items-start space-x-3 confession-item p-2 rounded">
                                <input type="checkbox" class="mt-1 w-4 h-4 text-red-600 rounded" data-sin="gossip">
                                <span class="text-sm"><strong>Gossip</strong> - Idle talk about others</span>
                            </label>
                            <label class="flex items-start space-x-3 confession-item p-2 rounded">
                                <input type="checkbox" class="mt-1 w-4 h-4 text-red-600 rounded" data-sin="stealing">
                                <span class="text-sm"><strong>Stealing</strong> - Taking what belongs to another</span>
                            </label>
                            <label class="flex items-start space-x-3 confession-item p-2 rounded">
                                <input type="checkbox" class="mt-1 w-4 h-4 text-red-600 rounded" data-sin="cheating">
                                <span class="text-sm"><strong>Cheating</strong> - Dishonesty in business, school, or other dealings</span>
                            </label>
                            <label class="flex items-start space-x-3 confession-item p-2 rounded">
                                <input type="checkbox" class="mt-1 w-4 h-4 text-red-600 rounded" data-sin="damaging-property">
                                <span class="text-sm"><strong>Damaging Property</strong> - Vandalism or destruction of others' goods</span>
                            </label>
                        </div>
                    </div>

                    <!-- Sins Against Oneself and Purity -->
                    <div class="mb-6">
                        <h4 class="font-bold text-gray-700 mb-3 text-lg border-b pb-2">Sins Against Purity and Self</h4>
                        <div class="space-y-2">
                            <label class="flex items-start space-x-3 confession-item p-2 rounded">
                                <input type="checkbox" class="mt-1 w-4 h-4 text-red-600 rounded" data-sin="fornication">
                                <span class="text-sm"><strong>Fornication</strong> - Sexual relations outside of marriage</span>
                            </label>
                            <label class="flex items-start space-x-3 confession-item p-2 rounded">
                                <input type="checkbox" class="mt-1 w-4 h-4 text-red-600 rounded" data-sin="adultery">
                                <span class="text-sm"><strong>Adultery</strong> - Infidelity in marriage</span>
                            </label>
                            <label class="flex items-start space-x-3 confession-item p-2 rounded">
                                <input type="checkbox" class="mt-1 w-4 h-4 text-red-600 rounded" data-sin="masturbation">
                                <span class="text-sm"><strong>Masturbation</strong> - Self-abuse</span>
                            </label>
                            <label class="flex items-start space-x-3 confession-item p-2 rounded">
                                <input type="checkbox" class="mt-1 w-4 h-4 text-red-600 rounded" data-sin="pornography">
                                <span class="text-sm"><strong>Pornography</strong> - Viewing, distributing, or creating impure images</span>
                            </label>
                            <label class="flex items-start space-x-3 confession-item p-2 rounded">
                                <input type="checkbox" class="mt-1 w-4 h-4 text-red-600 rounded" data-sin="impure-thoughts">
                                <span class="text-sm"><strong>Impure Thoughts</strong> - Deliberately entertaining lustful thoughts</span>
                            </label>
                            <label class="flex items-start space-x-3 confession-item p-2 rounded">
                                <input type="checkbox" class="mt-1 w-4 h-4 text-red-600 rounded" data-sin="contraception">
                                <span class="text-sm"><strong>Contraception</strong> - Artificial prevention of conception</span>
                            </label>
                            <label class="flex items-start space-x-3 confession-item p-2 rounded">
                                <input type="checkbox" class="mt-1 w-4 h-4 text-red-600 rounded" data-sin="immodesty">
                                <span class="text-sm"><strong>Immodesty</strong> - Dressing or acting in ways that provoke lust</span>
                            </label>
                            <label class="flex items-start space-x-3 confession-item p-2 rounded">
                                <input type="checkbox" class="mt-1 w-4 h-4 text-red-600 rounded" data-sin="drunkenness">
                                <span class="text-sm"><strong>Drunkenness</strong> - Excessive consumption of alcohol</span>
                            </label>
                            <label class="flex items-start space-x-3 confession-item p-2 rounded">
                                <input type="checkbox" class="mt-1 w-4 h-4 text-red-600 rounded" data-sin="drug-abuse">
                                <span class="text-sm"><strong>Drug Abuse</strong> - Illicit drug use or misuse of prescription drugs</span>
                            </label>
                            <label class="flex items-start space-x-3 confession-item p-2 rounded">
                                <input type="checkbox" class="mt-1 w-4 h-4 text-red-600 rounded" data-sin="gluttony">
                                <span class="text-sm"><strong>Gluttony</strong> - Overindulgence in food or drink</span>
                            </label>
                        </div>
                    </div>

                    <!-- Capital Sins / Vice -->
                    <div class="mb-6">
                        <h4 class="font-bold text-gray-700 mb-3 text-lg border-b pb-2">Capital Sins</h4>
                        <div class="space-y-2">
                            <label class="flex items-start space-x-3 confession-item p-2 rounded">
                                <input type="checkbox" class="mt-1 w-4 h-4 text-red-600 rounded" data-sin="pride">
                                <span class="text-sm"><strong>Pride</strong> - Excessive love of self, arrogance</span>
                            </label>
                            <label class="flex items-start space-x-3 confession-item p-2 rounded">
                                <input type="checkbox" class="mt-1 w-4 h-4 text-red-600 rounded" data-sin="greed">
                                <span class="text-sm"><strong>Greed/Avarice</strong> - Excessive desire for wealth or possessions</span>
                            </label>
                            <label class="flex items-start space-x-3 confession-item p-2 rounded">
                                <input type="checkbox" class="mt-1 w-4 h-4 text-red-600 rounded" data-sin="envy">
                                <span class="text-sm"><strong>Envy</strong> - Sadness at another's good fortune</span>
                            </label>
                            <label class="flex items-start space-x-3 confession-item p-2 rounded">
                                <input type="checkbox" class="mt-1 w-4 h-4 text-red-600 rounded" data-sin="sloth">
                                <span class="text-sm"><strong>Sloth</strong> - Spiritual laziness, neglect of duties</span>
                            </label>
                        </div>
                    </div>

                    <!-- Other Grave Matters -->
                    <div class="mb-6">
                        <h4 class="font-bold text-gray-700 mb-3 text-lg border-b pb-2">Other Grave Matters</h4>
                        <div class="space-y-2">
                            <label class="flex items-start space-x-3 confession-item p-2 rounded">
                                <input type="checkbox" class="mt-1 w-4 h-4 text-red-600 rounded" data-sin="sacrilege">
                                <span class="text-sm"><strong>Sacrilege</strong> - Profaning sacred persons, places, or things</span>
                            </label>
                            <label class="flex items-start space-x-3 confession-item p-2 rounded">
                                <input type="checkbox" class="mt-1 w-4 h-4 text-red-600 rounded" data-sin="receiving-unworthily">
                                <span class="text-sm"><strong>Receiving Communion Unworthily</strong> - Receiving in state of mortal sin</span>
                            </label>
                            <label class="flex items-start space-x-3 confession-item p-2 rounded">
                                <input type="checkbox" class="mt-1 w-4 h-4 text-red-600 rounded" data-sin="despair">
                                <span class="text-sm"><strong>Despair</strong> - Loss of hope in God's mercy</span>
                            </label>
                            <label class="flex items-start space-x-3 confession-item p-2 rounded">
                                <input type="checkbox" class="mt-1 w-4 h-4 text-red-600 rounded" data-sin="presumption">
                                <span class="text-sm"><strong>Presumption</strong> - Expecting salvation without conversion or effort</span>
                            </label>
                        </div>
                    </div>

                    <div class="mt-6">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Additional Notes (Optional)</label>
                        <textarea id="confession-notes" rows="3" 
                                  class="w-full px-3 py-2 border border-gray-300 rounded-md"
                                  placeholder="Any other sins or spiritual insights..."></textarea>
                    </div>

                    <div class="mt-6 flex space-x-4">
                        <button onclick="saveConfession()" 
                                class="bg-green-600 text-white px-6 py-3 rounded-md hover:bg-green-700 transition font-semibold">
                            Save Examination
                        </button>
                        <button onclick="cancelConfession()" 
                                class="bg-gray-400 text-white px-6 py-3 rounded-md hover:bg-gray-500 transition">
                            Cancel
                        </button>
                    </div>
                </div>

                <!-- Confession History -->
                <div id="confession-history" class="mt-6">
                    <h3 class="text-xl font-semibold text-gray-800 mb-3">Examination History</h3>
                    <div id="confession-list" class="space-y-3">
                        <!-- Will be populated dynamically -->
                    </div>
                </div>
            </div>

            <!-- Sin Tracker Tab -->
            <div id="confession-tracker-tab" class="tab-content p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Track Sins Between Confessions</h2>
                
                <div class="bg-purple-50 border border-purple-200 rounded-lg p-4 mb-6">
                    <p class="text-sm text-purple-900 mb-2">
                        <strong>Days Since Last Confession:</strong> <span id="days-since-confession">-</span>
                    </p>
                    <p class="text-sm text-purple-900">
                        <strong>Next Recommended Confession:</strong> <span id="next-confession-date">-</span>
                    </p>
                </div>

                <div class="bg-amber-50 border border-amber-200 rounded-lg p-4 mb-6">
                    <h3 class="font-semibold text-amber-900 mb-2">How This Works</h3>
                    <p class="text-sm text-gray-700 mb-2">
                        Track specific sins you struggle with between confessions. Each day you commit a sin, 
                        mark it here. When you go to confession, the counts reset but progress is saved.
                    </p>
                    <p class="text-sm text-gray-700">
                        This helps you see patterns, track improvement, and prepare for confession.
                    </p>
                </div>

                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-3">Today's Sin Tracking</h3>
                    <p class="text-sm text-gray-500 mb-4" id="tracker-date"></p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="sin-tracker-list">
                        <!-- Will be populated with common sins -->
                    </div>
                    
                    <button onclick="showAllSinTrackers()" class="mt-4 text-indigo-600 hover:underline text-sm">
                        + Add more sins to track
                    </button>
                </div>

                <div class="bg-blue-50 border border-blue-200 rounded-lg p-6">
                    <h3 class="text-lg font-semibold text-blue-900 mb-3">Current Period Summary</h3>
                    <div id="sin-summary" class="space-y-2">
                        <!-- Will be populated dynamically -->
                    </div>
                </div>
            </div>

            <!-- Works of Mercy Tab -->
            <div id="mercy-tab" class="tab-content p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Works of Mercy</h2>
                
                <!-- Corporal Works -->
                <div class="mb-8">
                    <h3 class="text-xl font-semibold text-orange-800 mb-4 border-b-2 border-orange-300 pb-2">
                        Corporal Works of Mercy
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="bg-orange-50 p-4 rounded-lg border border-orange-200">
                            <label class="flex items-start space-x-3">
                                <input type="checkbox" class="mt-1 w-5 h-5 text-orange-600 rounded" onchange="saveWorkOfMercy('feed-hungry')">
                                <div>
                                    <span class="font-semibold text-gray-800 block">Feed the Hungry</span>
                                    <span class="text-sm text-gray-600">Provide food to those in need</span>
                                </div>
                            </label>
                            <textarea placeholder="Details (optional)" rows="2" 
                                      class="w-full mt-2 px-3 py-2 border border-orange-300 rounded-md text-sm"
                                      onchange="saveWorkOfMercyNotes('feed-hungry', this.value)"></textarea>
                        </div>

                        <div class="bg-orange-50 p-4 rounded-lg border border-orange-200">
                            <label class="flex items-start space-x-3">
                                <input type="checkbox" class="mt-1 w-5 h-5 text-orange-600 rounded" onchange="saveWorkOfMercy('give-drink')">
                                <div>
                                    <span class="font-semibold text-gray-800 block">Give Drink to the Thirsty</span>
                                    <span class="text-sm text-gray-600">Provide water or refreshment</span>
                                </div>
                            </label>
                            <textarea placeholder="Details (optional)" rows="2" 
                                      class="w-full mt-2 px-3 py-2 border border-orange-300 rounded-md text-sm"
                                      onchange="saveWorkOfMercyNotes('give-drink', this.value)"></textarea>
                        </div>

                        <div class="bg-orange-50 p-4 rounded-lg border border-orange-200">
                            <label class="flex items-start space-x-3">
                                <input type="checkbox" class="mt-1 w-5 h-5 text-orange-600 rounded" onchange="saveWorkOfMercy('clothe-naked')">
                                <div>
                                    <span class="font-semibold text-gray-800 block">Clothe the Naked</span>
                                    <span class="text-sm text-gray-600">Donate clothing or help those without</span>
                                </div>
                            </label>
                            <textarea placeholder="Details (optional)" rows="2" 
                                      class="w-full mt-2 px-3 py-2 border border-orange-300 rounded-md text-sm"
                                      onchange="saveWorkOfMercyNotes('clothe-naked', this.value)"></textarea>
                        </div>

                        <div class="bg-orange-50 p-4 rounded-lg border border-orange-200">
                            <label class="flex items-start space-x-3">
                                <input type="checkbox" class="mt-1 w-5 h-5 text-orange-600 rounded" onchange="saveWorkOfMercy('shelter-homeless')">
                                <div>
                                    <span class="font-semibold text-gray-800 block">Shelter the Homeless</span>
                                    <span class="text-sm text-gray-600">Provide housing or support shelters</span>
                                </div>
                            </label>
                            <textarea placeholder="Details (optional)" rows="2" 
                                      class="w-full mt-2 px-3 py-2 border border-orange-300 rounded-md text-sm"
                                      onchange="saveWorkOfMercyNotes('shelter-homeless', this.value)"></textarea>
                        </div>

                        <div class="bg-orange-50 p-4 rounded-lg border border-orange-200">
                            <label class="flex items-start space-x-3">
                                <input type="checkbox" class="mt-1 w-5 h-5 text-orange-600 rounded" onchange="saveWorkOfMercy('visit-sick')">
                                <div>
                                    <span class="font-semibold text-gray-800 block">Visit the Sick</span>
                                    <span class="text-sm text-gray-600">Care for the ill and infirm</span>
                                </div>
                            </label>
                            <textarea placeholder="Details (optional)" rows="2" 
                                      class="w-full mt-2 px-3 py-2 border border-orange-300 rounded-md text-sm"
                                      onchange="saveWorkOfMercyNotes('visit-sick', this.value)"></textarea>
                        </div>

                        <div class="bg-orange-50 p-4 rounded-lg border border-orange-200">
                            <label class="flex items-start space-x-3">
                                <input type="checkbox" class="mt-1 w-5 h-5 text-orange-600 rounded" onchange="saveWorkOfMercy('visit-imprisoned')">
                                <div>
                                    <span class="font-semibold text-gray-800 block">Visit the Imprisoned</span>
                                    <span class="text-sm text-gray-600">Minister to those in prison</span>
                                </div>
                            </label>
                            <textarea placeholder="Details (optional)" rows="2" 
                                      class="w-full mt-2 px-3 py-2 border border-orange-300 rounded-md text-sm"
                                      onchange="saveWorkOfMercyNotes('visit-imprisoned', this.value)"></textarea>
                        </div>

                        <div class="bg-orange-50 p-4 rounded-lg border border-orange-200">
                            <label class="flex items-start space-x-3">
                                <input type="checkbox" class="mt-1 w-5 h-5 text-orange-600 rounded" onchange="saveWorkOfMercy('bury-dead')">
                                <div>
                                    <span class="font-semibold text-gray-800 block">Bury the Dead</span>
                                    <span class="text-sm text-gray-600">Honor the deceased, attend funerals</span>
                                </div>
                            </label>
                            <textarea placeholder="Details (optional)" rows="2" 
                                      class="w-full mt-2 px-3 py-2 border border-orange-300 rounded-md text-sm"
                                      onchange="saveWorkOfMercyNotes('bury-dead', this.value)"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Spiritual Works -->
                <div>
                    <h3 class="text-xl font-semibold text-blue-800 mb-4 border-b-2 border-blue-300 pb-2">
                        Spiritual Works of Mercy
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                            <label class="flex items-start space-x-3">
                                <input type="checkbox" class="mt-1 w-5 h-5 text-blue-600 rounded" onchange="saveWorkOfMercy('instruct-ignorant')">
                                <div>
                                    <span class="font-semibold text-gray-800 block">Instruct the Ignorant</span>
                                    <span class="text-sm text-gray-600">Share knowledge of the faith</span>
                                </div>
                            </label>
                            <textarea placeholder="Details (optional)" rows="2" 
                                      class="w-full mt-2 px-3 py-2 border border-blue-300 rounded-md text-sm"
                                      onchange="saveWorkOfMercyNotes('instruct-ignorant', this.value)"></textarea>
                        </div>

                        <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                            <label class="flex items-start space-x-3">
                                <input type="checkbox" class="mt-1 w-5 h-5 text-blue-600 rounded" onchange="saveWorkOfMercy('counsel-doubtful')">
                                <div>
                                    <span class="font-semibold text-gray-800 block">Counsel the Doubtful</span>
                                    <span class="text-sm text-gray-600">Provide spiritual guidance</span>
                                </div>
                            </label>
                            <textarea placeholder="Details (optional)" rows="2" 
                                      class="w-full mt-2 px-3 py-2 border border-blue-300 rounded-md text-sm"
                                      onchange="saveWorkOfMercyNotes('counsel-doubtful', this.value)"></textarea>
                        </div>

                        <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                            <label class="flex items-start space-x-3">
                                <input type="checkbox" class="mt-1 w-5 h-5 text-blue-600 rounded" onchange="saveWorkOfMercy('admonish-sinners')">
                                <div>
                                    <span class="font-semibold text-gray-800 block">Admonish Sinners</span>
                                    <span class="text-sm text-gray-600">Fraternal correction with charity</span>
                                </div>
                            </label>
                            <textarea placeholder="Details (optional)" rows="2" 
                                      class="w-full mt-2 px-3 py-2 border border-blue-300 rounded-md text-sm"
                                      onchange="saveWorkOfMercyNotes('admonish-sinners', this.value)"></textarea>
                        </div>

                        <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                            <label class="flex items-start space-x-3">
                                <input type="checkbox" class="mt-1 w-5 h-5 text-blue-600 rounded" onchange="saveWorkOfMercy('bear-wrongs')">
                                <div>
                                    <span class="font-semibold text-gray-800 block">Bear Wrongs Patiently</span>
                                    <span class="text-sm text-gray-600">Endure injuries without resentment</span>
                                </div>
                            </label>
                            <textarea placeholder="Details (optional)" rows="2" 
                                      class="w-full mt-2 px-3 py-2 border border-blue-300 rounded-md text-sm"
                                      onchange="saveWorkOfMercyNotes('bear-wrongs', this.value)"></textarea>
                        </div>

                        <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                            <label class="flex items-start space-x-3">
                                <input type="checkbox" class="mt-1 w-5 h-5 text-blue-600 rounded" onchange="saveWorkOfMercy('forgive-offenses')">
                                <div>
                                    <span class="font-semibold text-gray-800 block">Forgive Offenses Willingly</span>
                                    <span class="text-sm text-gray-600">Practice mercy and forgiveness</span>
                                </div>
                            </label>
                            <textarea placeholder="Details (optional)" rows="2" 
                                      class="w-full mt-2 px-3 py-2 border border-blue-300 rounded-md text-sm"
                                      onchange="saveWorkOfMercyNotes('forgive-offenses', this.value)"></textarea>
                        </div>

                        <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                            <label class="flex items-start space-x-3">
                                <input type="checkbox" class="mt-1 w-5 h-5 text-blue-600 rounded" onchange="saveWorkOfMercy('comfort-afflicted')">
                                <div>
                                    <span class="font-semibold text-gray-800 block">Comfort the Afflicted</span>
                                    <span class="text-sm text-gray-600">Console those who suffer</span>
                                </div>
                            </label>
                            <textarea placeholder="Details (optional)" rows="2" 
                                      class="w-full mt-2 px-3 py-2 border border-blue-300 rounded-md text-sm"
                                      onchange="saveWorkOfMercyNotes('comfort-afflicted', this.value)"></textarea>
                        </div>

                        <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                            <label class="flex items-start space-x-3">
                                <input type="checkbox" class="mt-1 w-5 h-5 text-blue-600 rounded" onchange="saveWorkOfMercy('pray-living-dead')">
                                <div>
                                    <span class="font-semibold text-gray-800 block">Pray for the Living and Dead</span>
                                    <span class="text-sm text-gray-600">Intercede for others and holy souls</span>
                                </div>
                            </label>
                            <textarea placeholder="Details (optional)" rows="2" 
                                      class="w-full mt-2 px-3 py-2 border border-blue-300 rounded-md text-sm"
                                      onchange="saveWorkOfMercyNotes('pray-living-dead', this.value)"></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <!-- History/Calendar Tab -->
            <div id="history-tab" class="tab-content p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Spiritual Journey History</h2>
                
                <div class="mb-6 flex flex-wrap gap-4">
                    <button onclick="changeHistoryView('week')" id="view-week" class="px-4 py-2 bg-indigo-600 text-white rounded-md font-semibold">
                        Last 7 Days
                    </button>
                    <button onclick="changeHistoryView('month')" id="view-month" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md font-semibold hover:bg-gray-300">
                        Last 30 Days
                    </button>
                    <button onclick="changeHistoryView('all')" id="view-all" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md font-semibold hover:bg-gray-300">
                        All Time
                    </button>
                </div>
                
                <div id="history-calendar" class="space-y-4">
                    <!-- Will be populated dynamically -->
                </div>
                
                <div id="no-history" style="display: none;" class="bg-gray-50 border border-gray-200 rounded-lg p-8 text-center">
                    <p class="text-gray-600">No activity recorded yet. Start tracking your spiritual journey today!</p>
                </div>
            </div>

            <!-- Data Management Tab -->
            <div id="data-tab" class="tab-content p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Data Management</h2>
                
                <div class="space-y-6">
                    <!-- Export Section -->
                    <div class="bg-green-50 border border-green-200 rounded-lg p-6">
                        <h3 class="text-xl font-semibold text-green-900 mb-3">üì§ Export Your Data</h3>
                        <p class="text-gray-700 mb-4">
                            Download all your spiritual tracking data as a backup file. This includes:
                        </p>
                        <ul class="list-disc list-inside text-gray-700 mb-4 space-y-1">
                            <li>All daily activities and notes</li>
                            <li>Confession records (examination history)</li>
                            <li>Works of mercy performed</li>
                            <li>All dates and timestamps</li>
                        </ul>
                        <p class="text-sm text-amber-700 mb-4">
                            ‚ö†Ô∏è <strong>Privacy Note:</strong> Your confession records contain sensitive spiritual information. 
                            Keep your backup file secure and private.
                        </p>
                        <button onclick="exportData()" 
                                class="bg-green-600 text-white px-6 py-3 rounded-md hover:bg-green-700 transition font-semibold shadow-md">
                            üì• Download Backup File
                        </button>
                        <div id="export-status" class="mt-3 text-sm"></div>
                    </div>

                    <!-- Import Section -->
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-6">
                        <h3 class="text-xl font-semibold text-blue-900 mb-3">üì• Import Data</h3>
                        <p class="text-gray-700 mb-4">
                            Restore data from a previous backup file. This will:
                        </p>
                        <ul class="list-disc list-inside text-gray-700 mb-4 space-y-1">
                            <li><strong>Merge</strong> imported data with existing data</li>
                            <li>Keep the most recent version if dates overlap</li>
                            <li>Not delete any current data</li>
                        </ul>
                        <p class="text-sm text-amber-700 mb-4">
                            ‚ö†Ô∏è <strong>Important:</strong> Only import backup files you created from this app. 
                            Invalid files may cause errors.
                        </p>
                        <div class="space-y-3">
                            <input type="file" id="import-file" accept=".json" 
                                   class="block w-full text-sm text-gray-700 file:mr-4 file:py-2 file:px-4 
                                          file:rounded-md file:border-0 file:text-sm file:font-semibold 
                                          file:bg-blue-600 file:text-white hover:file:bg-blue-700 
                                          border border-blue-300 rounded-md">
                            <button onclick="importData()" 
                                    class="bg-blue-600 text-white px-6 py-3 rounded-md hover:bg-blue-700 transition font-semibold shadow-md">
                                üì§ Import Backup File
                            </button>
                        </div>
                        <div id="import-status" class="mt-3 text-sm"></div>
                    </div>

                    <!-- Clear Data Section -->
                    <div class="bg-red-50 border border-red-200 rounded-lg p-6">
                        <h3 class="text-xl font-semibold text-red-900 mb-3">üóëÔ∏è Clear All Data</h3>
                        <p class="text-gray-700 mb-4">
                            Permanently delete ALL your spiritual tracking data. This action cannot be undone.
                        </p>
                        <p class="text-sm text-red-700 mb-4">
                            ‚ö†Ô∏è <strong>Warning:</strong> This will delete everything - all activities, confessions, and works of mercy. 
                            Make sure to export a backup first if you want to keep your data!
                        </p>
                        <button onclick="clearAllData()" 
                                class="bg-red-600 text-white px-6 py-3 rounded-md hover:bg-red-700 transition font-semibold shadow-md">
                            üóëÔ∏è Clear All Data
                        </button>
                        <div id="clear-status" class="mt-3 text-sm"></div>
                    </div>

                    <!-- Info Section -->
                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-6">
                        <h3 class="text-xl font-semibold text-gray-900 mb-3">‚ÑπÔ∏è About Your Data</h3>
                        <div class="text-gray-700 space-y-2 text-sm">
                            <p><strong>Storage Location:</strong> All data is stored locally on this device only.</p>
                            <p><strong>Privacy:</strong> Nothing is uploaded to any server. Your data stays private.</p>
                            <p><strong>Sharing Devices:</strong> To move data to another device, export on one device and import on the other.</p>
                            <p><strong>File Format:</strong> Backup files are in JSON format and contain all your tracked data.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Progress Tab -->
            <div id="progress-tab" class="tab-content p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Your Spiritual Journey</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-gradient-to-br from-purple-100 to-purple-200 p-6 rounded-lg shadow">
                        <h3 class="text-lg font-semibold text-purple-900 mb-2">Total Days Tracked</h3>
                        <p class="text-4xl font-bold text-purple-700" id="total-days">0</p>
                    </div>
                    
                    <div class="bg-gradient-to-br from-blue-100 to-blue-200 p-6 rounded-lg shadow">
                        <h3 class="text-lg font-semibold text-blue-900 mb-2">Sacrament of Reconciliation</h3>
                        <p class="text-4xl font-bold text-blue-700" id="total-confessions">0</p>
                        <p class="text-sm text-blue-800 mt-1">confessions</p>
                    </div>
                    
                    <div class="bg-gradient-to-br from-green-100 to-green-200 p-6 rounded-lg shadow">
                        <h3 class="text-lg font-semibold text-green-900 mb-2">Works of Mercy</h3>
                        <p class="text-4xl font-bold text-green-700" id="total-mercy-works">0</p>
                        <p class="text-sm text-green-800 mt-1">performed</p>
                    </div>
                </div>

                <div class="bg-white border border-gray-200 rounded-lg p-6 mb-6">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Last 30 Days Activity</h3>
                    <div id="activity-summary" class="space-y-3">
                        <!-- Will be populated dynamically -->
                    </div>
                </div>

                <div class="bg-amber-50 border border-amber-200 rounded-lg p-6">
                    <h3 class="text-xl font-semibold text-amber-900 mb-3">üåü Remember</h3>
                    <p class="text-gray-700 italic">
                        "The saints are not the people who never sin, but the people who keep getting up after they fall."
                    </p>
                    <p class="text-gray-600 mt-3">
                        This tracker is a tool for your spiritual journey. Progress may be slow, but perseverance in prayer, 
                        the sacraments, and works of charity will lead you closer to God. Trust in His mercy and never give up!
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Storage Wrapper for Browser Compatibility
        // This wraps localStorage to work like the artifact storage API
        window.storage = {
            async get(key) {
                try {
                    const value = localStorage.getItem(key);
                    if (value === null) {
                        throw new Error('Key not found');
                    }
                    return { key: key, value: value };
                } catch (e) {
                    throw e;
                }
            },
            
            async set(key, value) {
                try {
                    localStorage.setItem(key, value);
                    return { key: key, value: value };
                } catch (e) {
                    console.error('Storage set error:', e);
                    return null;
                }
            },
            
            async delete(key) {
                try {
                    localStorage.removeItem(key);
                    return { key: key, deleted: true };
                } catch (e) {
                    console.error('Storage delete error:', e);
                    return null;
                }
            },
            
            async list(prefix) {
                try {
                    const keys = [];
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (!prefix || key.startsWith(prefix)) {
                            keys.push(key);
                        }
                    }
                    return { keys: keys, prefix: prefix };
                } catch (e) {
                    console.error('Storage list error:', e);
                    return { keys: [] };
                }
            }
        };

        // Security & Session Management - DISABLED
        let sessionActive = true; // Always active now
        let lastActivity = Date.now();
        let encryptionKey = null;

        // Simplified - no PIN required
        async function checkSecuritySetup() {
            // Skip all security checks - just start the app
            sessionActive = true;
            console.log('App starting without PIN security');
        }

        function startSessionMonitoring() {
            // No session monitoring needed without PIN
            console.log('Session monitoring disabled');
        }

        function updateActivity() {
            lastActivity = Date.now();
        }

        // Simple encryption using Web Crypto API (for optional encrypted exports)
        async function encrypt(text, password) {
            const encoder = new TextEncoder();
            const data = encoder.encode(text);
            const keyMaterial = await crypto.subtle.importKey(
                'raw',
                encoder.encode(password.padEnd(32, '0')),
                { name: 'AES-GCM' },
                false,
                ['encrypt']
            );
            const iv = crypto.getRandomValues(new Uint8Array(12));
            const encrypted = await crypto.subtle.encrypt(
                { name: 'AES-GCM', iv: iv },
                keyMaterial,
                data
            );
            const combined = new Uint8Array(iv.length + encrypted.byteLength);
            combined.set(iv);
            combined.set(new Uint8Array(encrypted), iv.length);
            return btoa(String.fromCharCode(...combined));
        }

        async function decrypt(encryptedText, password) {
            const encoder = new TextEncoder();
            const decoder = new TextDecoder();
            const combined = Uint8Array.from(atob(encryptedText), c => c.charCodeAt(0));
            const iv = combined.slice(0, 12);
            const data = combined.slice(12);
            
            const keyMaterial = await crypto.subtle.importKey(
                'raw',
                encoder.encode(password.padEnd(32, '0')),
                { name: 'AES-GCM' },
                false,
                ['decrypt']
            );
            
            const decrypted = await crypto.subtle.decrypt(
                { name: 'AES-GCM', iv: iv },
                keyMaterial,
                data
            );
            return decoder.decode(decrypted);
        }

        // Initialize

        let currentDate = getCurrentDate();
        
        function getCurrentDate() {
            // Get date in local timezone, format as YYYY-MM-DD
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        document.getElementById('today-date').textContent = new Date().toLocaleDateString('en-US', { 
            weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
        });

        // Daily Readings
        async function loadDailyReadings() {
            const readingsDate = document.getElementById('readings-date');
            const readingsLoading = document.getElementById('readings-loading');
            const readingsError = document.getElementById('readings-error');
            const readingsContent = document.getElementById('readings-content');
            
            readingsDate.textContent = new Date().toLocaleDateString('en-US', { 
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
            });
            
            // Format date for USCCB URL
            const today = new Date();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            const year = String(today.getFullYear()).slice(-2);
            const dateStr = `${month}${day}${year}`;
            
            // Direct link approach - more reliable than trying to fetch cross-origin
            const readingsHTML = `
                <div class="bg-gradient-to-r from-amber-50 to-yellow-50 border border-amber-300 rounded-lg p-6 mb-4">
                    <h3 class="font-semibold text-amber-900 mb-3 text-xl">üìñ Today's Mass Readings</h3>
                    <p class="text-gray-700 mb-4">
                        Read today's First Reading, Responsorial Psalm, Second Reading, and Gospel from the USCCB:
                    </p>
                    <a href="https://bible.usccb.org/bible/readings/${dateStr}.cfm" 
                       target="_blank"
                       class="inline-block bg-indigo-600 text-white px-6 py-3 rounded-md hover:bg-indigo-700 transition font-semibold shadow-md">
                        üìñ Open Today's Readings ‚Üí
                    </a>
                </div>
                
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 mb-4">
                    <h3 class="font-semibold text-blue-900 mb-3 text-xl">üôè Lectio Divina Guide</h3>
                    <p class="text-gray-700 mb-3">Use these steps for prayerful scripture reading:</p>
                    <ol class="list-decimal list-inside space-y-2 text-gray-700">
                        <li><strong>Lectio (Read):</strong> Read the passage slowly and attentively</li>
                        <li><strong>Meditatio (Meditate):</strong> Reflect on what strikes you</li>
                        <li><strong>Oratio (Pray):</strong> Respond to God in prayer</li>
                        <li><strong>Contemplatio (Contemplate):</strong> Rest in God's presence</li>
                    </ol>
                </div>
                
                <div class="bg-purple-50 border border-purple-200 rounded-lg p-6">
                    <h3 class="font-semibold text-purple-900 mb-3 text-xl">üìö Additional Resources</h3>
                    
                    <h4 class="font-semibold text-purple-800 mb-2 mt-4">AI & Digital Tools</h4>
                    <div class="space-y-2 mb-4">
                        <a href="https://magisterium.com/" target="_blank" 
                           class="block text-indigo-600 hover:underline">
                            ‚Üí Magisterium AI - Catholic Teaching Assistant
                        </a>
                        <a href="https://read.amazon.com/" target="_blank" 
                           class="block text-indigo-600 hover:underline">
                            ‚Üí Kindle Cloud Reader
                        </a>
                    </div>
                    
                    <h4 class="font-semibold text-purple-800 mb-2 mt-4">Daily Readings & Catholic Texts</h4>
                    <div class="space-y-2 mb-4">
                        <a href="https://www.vaticannews.va/en/word-of-the-day.html" target="_blank" 
                           class="block text-indigo-600 hover:underline">
                            ‚Üí Vatican News - Word of the Day
                        </a>
                        <a href="https://bible.usccb.org/" target="_blank" 
                           class="block text-indigo-600 hover:underline">
                            ‚Üí USCCB Bible Browser
                        </a>
                        <a href="https://www.vatican.va/archive/ENG0015/_INDEX.HTM" target="_blank" 
                           class="block text-indigo-600 hover:underline">
                            ‚Üí Catechism of the Catholic Church
                        </a>
                        <a href="https://www.newadvent.org/summa/" target="_blank" 
                           class="block text-indigo-600 hover:underline">
                            ‚Üí Summa Theologica - St. Thomas Aquinas
                        </a>
                        <a href="https://www.newadvent.org/fathers/" target="_blank" 
                           class="block text-indigo-600 hover:underline">
                            ‚Üí Church Fathers
                        </a>
                        <a href="https://fultonsheen.com/" target="_blank" 
                           class="block text-indigo-600 hover:underline">
                            ‚Üí Fulton Sheen Archive - Complete Works
                        </a>
                        <a href="https://www.vatican.va/content/vatican/en.html" target="_blank" 
                           class="block text-indigo-600 hover:underline">
                            ‚Üí Vatican Official Website
                        </a>
                    </div>
                    
                    <h4 class="font-semibold text-purple-800 mb-2 mt-4">Prayer & Meditation</h4>
                    <div class="space-y-2 mb-4">
                        <a href="https://hallow.com/" target="_blank" 
                           class="block text-indigo-600 hover:underline">
                            ‚Üí Hallow - Catholic Prayer & Meditation App
                        </a>
                        <a href="https://www.ewtn.com/" target="_blank" 
                           class="block text-indigo-600 hover:underline">
                            ‚Üí EWTN - Global Catholic Network
                        </a>
                        <a href="https://www.sacredspace.com/" target="_blank" 
                           class="block text-indigo-600 hover:underline">
                            ‚Üí Sacred Space - Daily Prayer
                        </a>
                    </div>
                    
                    <h4 class="font-semibold text-purple-800 mb-2 mt-4">Catholic Resources & Communities</h4>
                    <div class="space-y-2">
                        <a href="https://www.catholic.com/" target="_blank" 
                           class="block text-indigo-600 hover:underline">
                            ‚Üí Catholic Answers
                        </a>
                        <a href="https://www.wordonfire.org/" target="_blank" 
                           class="block text-indigo-600 hover:underline">
                            ‚Üí Word on Fire - Bishop Barron
                        </a>
                        <a href="https://www.osv.com/" target="_blank" 
                           class="block text-indigo-600 hover:underline">
                            ‚Üí Our Sunday Visitor
                        </a>
                        <a href="https://www.catholic365.com/" target="_blank" 
                           class="block text-indigo-600 hover:underline">
                            ‚Üí Catholic 365
                        </a>
                        <a href="https://www.newadvent.org/" target="_blank" 
                           class="block text-indigo-600 hover:underline">
                            ‚Üí New Advent - Catholic Encyclopedia
                        </a>
                    </div>
                </div>
            `;
            
            readingsLoading.style.display = 'none';
            readingsContent.innerHTML = readingsHTML;
            readingsContent.style.display = 'block';
        }

        // Tab switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('text-gray-700', 'border-indigo-600');
                btn.classList.add('text-gray-500', 'border-transparent');
            });
            
            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.remove('text-gray-500', 'border-transparent');
            event.target.classList.add('text-gray-700', 'border-indigo-600');
            
            if (tabName === 'progress') {
                updateProgressStats();
            } else if (tabName === 'readings') {
                loadDailyReadings();
            } else if (tabName === 'history') {
                loadHistory('week');
            } else if (tabName === 'confession-tracker') {
                loadSinTrackers();
            }
        }

        // Daily Activities
        async function saveDailyActivity(activity) {
            try {
                currentDate = getCurrentDate(); // Refresh in case date changed
                const key = `daily:${currentDate}`;
                console.log('Saving activity:', activity, 'for date:', currentDate);
                
                let dailyData = {};
                
                try {
                    const result = await window.storage.get(key);
                    if (result && result.value) {
                        dailyData = JSON.parse(result.value);
                    }
                } catch (e) {
                    // Key doesn't exist yet
                }
                
                const checkbox = event.target;
                dailyData[activity] = checkbox.checked;
                
                const saveResult = await window.storage.set(key, JSON.stringify(dailyData));
                console.log('Save result:', saveResult);
            } catch (error) {
                console.error('Error saving daily activity:', error);
                alert('Error saving data. Please check console for details.');
            }
        }

        async function saveDailyActivityMinutes(activity, minutes) {
            try {
                const key = `daily:${currentDate}`;
                let dailyData = {};
                
                try {
                    const result = await window.storage.get(key);
                    if (result && result.value) {
                        dailyData = JSON.parse(result.value);
                    }
                } catch (e) {
                    // Key doesn't exist yet
                }
                
                dailyData[activity + '_minutes'] = parseInt(minutes) || 0;
                
                await window.storage.set(key, JSON.stringify(dailyData));
            } catch (error) {
                console.error('Error saving activity minutes:', error);
            }
        }

        async function saveDailyNotes() {
            try {
                const key = `daily:${currentDate}`;
                let dailyData = {};
                
                try {
                    const result = await window.storage.get(key);
                    if (result && result.value) {
                        dailyData = JSON.parse(result.value);
                    }
                } catch (e) {
                    // Key doesn't exist yet
                }
                
                dailyData.notes = document.getElementById('daily-notes').value;
                
                await window.storage.set(key, JSON.stringify(dailyData));
            } catch (error) {
                console.error('Error saving daily notes:', error);
            }
        }

        // Confession Functions
        async function loadLastConfession() {
            try {
                const result = await window.storage.list('confession:');
                if (result && result.keys && result.keys.length > 0) {
                    const sortedKeys = result.keys.sort().reverse();
                    const lastKey = sortedKeys[0];
                    const confessionData = await window.storage.get(lastKey);
                    if (confessionData && confessionData.value) {
                        const data = JSON.parse(confessionData.value);
                        document.getElementById('last-confession-date').textContent = 
                            new Date(data.date).toLocaleDateString('en-US', { 
                                year: 'numeric', month: 'long', day: 'numeric' 
                            });
                    }
                }
            } catch (error) {
                console.error('Error loading last confession:', error);
            }
            
            await loadConfessionHistory();
        }

        function recordNewConfession() {
            document.getElementById('confession-form').style.display = 'block';
            // Clear previous selections
            document.querySelectorAll('#confession-form input[type="checkbox"]').forEach(cb => cb.checked = false);
            document.getElementById('confession-notes').value = '';
        }

        function cancelConfession() {
            document.getElementById('confession-form').style.display = 'none';
        }

        async function saveConfession() {
            try {
                const sins = [];
                document.querySelectorAll('#confession-form input[type="checkbox"]:checked').forEach(checkbox => {
                    sins.push(checkbox.dataset.sin);
                });
                
                console.log('Saving confession with sins:', sins);
                
                const confessionData = {
                    date: new Date().toISOString(),
                    sins: sins,
                    notes: document.getElementById('confession-notes').value
                };
                
                const key = `confession:${Date.now()}`;
                console.log('Confession key:', key);
                console.log('Confession data:', confessionData);
                
                const saveResult = await window.storage.set(key, JSON.stringify(confessionData));
                console.log('Confession save result:', saveResult);
                
                if (!saveResult) {
                    throw new Error('Storage returned null - save may have failed');
                }
                
                alert('‚úÖ Confession examination saved.\n\nRemember to complete the Sacrament with a priest.');
                cancelConfession();
                await loadLastConfession();
            } catch (error) {
                console.error('Error saving confession:', error);
                alert('‚ùå Error saving confession record:\n' + error.message + '\n\nPlease check the debug panel for more info.');
            }
        }

        async function loadConfessionHistory() {
            try {
                const result = await window.storage.list('confession:');
                const historyDiv = document.getElementById('confession-list');
                
                if (!result || !result.keys || result.keys.length === 0) {
                    historyDiv.innerHTML = '<p class="text-gray-500">No confessions recorded yet.</p>';
                    return;
                }
                
                const sortedKeys = result.keys.sort().reverse();
                let html = '';
                
                for (const key of sortedKeys.slice(0, 10)) {
                    const confessionData = await window.storage.get(key);
                    if (confessionData && confessionData.value) {
                        const data = JSON.parse(confessionData.value);
                        const dateStr = new Date(data.date).toLocaleDateString('en-US', { 
                            year: 'numeric', month: 'long', day: 'numeric' 
                        });
                        html += `
                            <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                                <p class="font-semibold text-gray-800">${dateStr}</p>
                                <p class="text-sm text-gray-600 mt-1">${data.sins.length} matter(s) examined</p>
                                ${data.notes ? `<p class="text-sm text-gray-600 mt-2 italic">${data.notes}</p>` : ''}
                            </div>
                        `;
                    }
                }
                
                historyDiv.innerHTML = html;
            } catch (error) {
                console.error('Error loading confession history:', error);
            }
        }

        // Works of Mercy
        async function saveWorkOfMercy(work) {
            try {
                const key = `mercy:${currentDate}`;
                let mercyData = {};
                
                try {
                    const result = await window.storage.get(key);
                    if (result && result.value) {
                        mercyData = JSON.parse(result.value);
                    }
                } catch (e) {
                    // Key doesn't exist yet
                }
                
                const checkbox = event.target;
                mercyData[work] = checkbox.checked;
                
                await window.storage.set(key, JSON.stringify(mercyData));
            } catch (error) {
                console.error('Error saving work of mercy:', error);
            }
        }

        async function saveWorkOfMercyNotes(work, notes) {
            try {
                const key = `mercy:${currentDate}`;
                let mercyData = {};
                
                try {
                    const result = await window.storage.get(key);
                    if (result && result.value) {
                        mercyData = JSON.parse(result.value);
                    }
                } catch (e) {
                    // Key doesn't exist yet
                }
                
                mercyData[work + '_notes'] = notes;
                
                await window.storage.set(key, JSON.stringify(mercyData));
            } catch (error) {
                console.error('Error saving work of mercy notes:', error);
            }
        }

        // History/Calendar Functions
        let currentHistoryView = 'week';
        
        function changeHistoryView(view) {
            currentHistoryView = view;
            
            // Update button styles
            document.querySelectorAll('[id^="view-"]').forEach(btn => {
                btn.classList.remove('bg-indigo-600', 'text-white');
                btn.classList.add('bg-gray-200', 'text-gray-700');
            });
            document.getElementById('view-' + view).classList.remove('bg-gray-200', 'text-gray-700');
            document.getElementById('view-' + view).classList.add('bg-indigo-600', 'text-white');
            
            loadHistory(view);
        }
        
        async function loadHistory(view) {
            try {
                const historyCalendar = document.getElementById('history-calendar');
                const noHistory = document.getElementById('no-history');
                
                // Get all daily activity keys
                const dailyResult = await window.storage.list('daily:');
                const mercyResult = await window.storage.list('mercy:');
                
                if ((!dailyResult || !dailyResult.keys || dailyResult.keys.length === 0) && 
                    (!mercyResult || !mercyResult.keys || mercyResult.keys.length === 0)) {
                    historyCalendar.style.display = 'none';
                    noHistory.style.display = 'block';
                    return;
                }
                
                historyCalendar.style.display = 'block';
                noHistory.style.display = 'none';
                
                // Combine all dates
                const allDates = new Set();
                if (dailyResult && dailyResult.keys) {
                    dailyResult.keys.forEach(key => {
                        const date = key.replace('daily:', '');
                        allDates.add(date);
                    });
                }
                if (mercyResult && mercyResult.keys) {
                    mercyResult.keys.forEach(key => {
                        const date = key.replace('mercy:', '');
                        allDates.add(date);
                    });
                }
                
                // Filter dates based on view
                const today = new Date();
                const filteredDates = Array.from(allDates).filter(dateStr => {
                    const date = new Date(dateStr);
                    const diffTime = today - date;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    
                    if (view === 'week') return diffDays <= 7;
                    if (view === 'month') return diffDays <= 30;
                    return true; // 'all'
                }).sort().reverse();
                
                if (filteredDates.length === 0) {
                    historyCalendar.innerHTML = '<p class="text-gray-500 text-center py-8">No activity in this time period</p>';
                    return;
                }
                
                // Build history HTML
                let html = '';
                
                for (const dateStr of filteredDates) {
                    const date = new Date(dateStr);
                    const formattedDate = date.toLocaleDateString('en-US', { 
                        weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
                    });
                    
                    // Get daily activities
                    let dailyActivities = [];
                    try {
                        const dailyData = await window.storage.get(`daily:${dateStr}`);
                        if (dailyData && dailyData.value) {
                            const data = JSON.parse(dailyData.value);
                            const activityLabels = {
                                'rosary': 'üåπ Rosary',
                                'mass': '‚õ™ Mass',
                                'bible': 'üìñ Bible Reading',
                                'adoration': 'üïØÔ∏è Adoration',
                                'divine-office': 'üìø Divine Office',
                                'divine-mercy': 'üôè Divine Mercy',
                                'spiritual-reading': 'üìö Spiritual Reading',
                                'meditation': 'üßò Meditation',
                                'fasting': 'üçû Fasting',
                                'examination': 'üîç Examination'
                            };
                            
                            for (const [key, label] of Object.entries(activityLabels)) {
                                if (data[key]) {
                                    let activity = label;
                                    if (data[key + '_minutes']) {
                                        activity += ` (${data[key + '_minutes']} min)`;
                                    }
                                    dailyActivities.push(activity);
                                }
                            }
                        }
                    } catch (e) {
                        // No daily data for this date
                    }
                    
                    // Get works of mercy
                    let mercyWorks = [];
                    try {
                        const mercyData = await window.storage.get(`mercy:${dateStr}`);
                        if (mercyData && mercyData.value) {
                            const data = JSON.parse(mercyData.value);
                            const mercyLabels = {
                                'feed-hungry': 'Feed the Hungry',
                                'give-drink': 'Give Drink',
                                'clothe-naked': 'Clothe the Naked',
                                'shelter-homeless': 'Shelter Homeless',
                                'visit-sick': 'Visit the Sick',
                                'visit-imprisoned': 'Visit Imprisoned',
                                'bury-dead': 'Bury the Dead',
                                'instruct-ignorant': 'Instruct the Ignorant',
                                'counsel-doubtful': 'Counsel the Doubtful',
                                'admonish-sinners': 'Admonish Sinners',
                                'bear-wrongs': 'Bear Wrongs Patiently',
                                'forgive-offenses': 'Forgive Offenses',
                                'comfort-afflicted': 'Comfort the Afflicted',
                                'pray-living-dead': 'Pray for Living & Dead'
                            };
                            
                            for (const [key, label] of Object.entries(mercyLabels)) {
                                if (data[key]) {
                                    mercyWorks.push(label);
                                }
                            }
                        }
                    } catch (e) {
                        // No mercy data for this date
                    }
                    
                    // Build day card
                    html += `
                        <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm">
                            <h3 class="text-lg font-bold text-gray-800 mb-3">${formattedDate}</h3>
                            
                            ${dailyActivities.length > 0 ? `
                                <div class="mb-4">
                                    <h4 class="text-sm font-semibold text-indigo-700 mb-2">Daily Activities:</h4>
                                    <div class="flex flex-wrap gap-2">
                                        ${dailyActivities.map(act => `
                                            <span class="inline-block bg-indigo-50 text-indigo-700 px-3 py-1 rounded-full text-sm">
                                                ${act}
                                            </span>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                            
                            ${mercyWorks.length > 0 ? `
                                <div>
                                    <h4 class="text-sm font-semibold text-orange-700 mb-2">Works of Mercy:</h4>
                                    <div class="flex flex-wrap gap-2">
                                        ${mercyWorks.map(work => `
                                            <span class="inline-block bg-orange-50 text-orange-700 px-3 py-1 rounded-full text-sm">
                                                ${work}
                                            </span>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                            
                            ${dailyActivities.length === 0 && mercyWorks.length === 0 ? `
                                <p class="text-gray-400 text-sm italic">No activities recorded</p>
                            ` : ''}
                        </div>
                    `;
                }
                
                historyCalendar.innerHTML = html;
                
            } catch (error) {
                console.error('Error loading history:', error);
                document.getElementById('history-calendar').innerHTML = 
                    '<p class="text-red-600">Error loading history. Please try again.</p>';
            }
        }

        // Progress Stats
        async function updateProgressStats() {
            try {
                // Count unique days
                const dailyResult = await window.storage.list('daily:');
                const totalDays = dailyResult && dailyResult.keys ? dailyResult.keys.length : 0;
                document.getElementById('total-days').textContent = totalDays;
                
                // Count confessions
                const confessionResult = await window.storage.list('confession:');
                const totalConfessions = confessionResult && confessionResult.keys ? confessionResult.keys.length : 0;
                document.getElementById('total-confessions').textContent = totalConfessions;
                
                // Count works of mercy
                let totalMercyWorks = 0;
                const mercyResult = await window.storage.list('mercy:');
                if (mercyResult && mercyResult.keys) {
                    for (const key of mercyResult.keys) {
                        const data = await window.storage.get(key);
                        if (data && data.value) {
                            const mercyData = JSON.parse(data.value);
                            totalMercyWorks += Object.keys(mercyData).filter(k => !k.endsWith('_notes') && mercyData[k]).length;
                        }
                    }
                }
                document.getElementById('total-mercy-works').textContent = totalMercyWorks;
                
                // Activity summary
                await loadActivitySummary();
            } catch (error) {
                console.error('Error updating progress stats:', error);
            }
        }

        async function loadActivitySummary() {
            try {
                const summaryDiv = document.getElementById('activity-summary');
                const activities = {
                    'rosary': 'Holy Rosary',
                    'mass': 'Holy Mass',
                    'bible': 'Bible Reading',
                    'adoration': 'Eucharistic Adoration',
                    'divine-office': 'Divine Office'
                };
                
                let html = '';
                for (const [key, label] of Object.entries(activities)) {
                    let count = 0;
                    const dailyResult = await window.storage.list('daily:');
                    
                    if (dailyResult && dailyResult.keys) {
                        for (const dayKey of dailyResult.keys) {
                            const data = await window.storage.get(dayKey);
                            if (data && data.value) {
                                const dailyData = JSON.parse(data.value);
                                if (dailyData[key]) count++;
                            }
                        }
                    }
                    
                    html += `
                        <div class="flex justify-between items-center p-3 bg-gray-50 rounded">
                            <span class="text-gray-700">${label}</span>
                            <span class="font-bold text-indigo-600">${count} days</span>
                        </div>
                    `;
                }
                
                summaryDiv.innerHTML = html;
            } catch (error) {
                console.error('Error loading activity summary:', error);
            }
        }

        // Load data on page load
        async function loadTodayData() {
            try {
                currentDate = getCurrentDate(); // Refresh date in case app was left open overnight
                const key = `daily:${currentDate}`;
                
                console.log('Loading data for date:', currentDate);
                console.log('Using storage key:', key);
                
                const result = await window.storage.get(key);
                
                if (result && result.value) {
                    const dailyData = JSON.parse(result.value);
                    console.log('Loaded daily data:', dailyData);
                    
                    // Restore checkboxes
                    document.querySelectorAll('#daily-tab input[type="checkbox"]').forEach(checkbox => {
                        const activity = checkbox.getAttribute('onchange').match(/'([^']+)'/)[1];
                        if (dailyData[activity]) {
                            checkbox.checked = true;
                        }
                    });
                    
                    // Restore minutes
                    const minuteInputs = document.querySelectorAll('#daily-tab input[type="number"]');
                    minuteInputs.forEach(input => {
                        const onchangeAttr = input.getAttribute('onchange');
                        if (onchangeAttr) {
                            const match = onchangeAttr.match(/'([^']+)'/);
                            if (match) {
                                const activity = match[1];
                                if (dailyData[activity + '_minutes']) {
                                    input.value = dailyData[activity + '_minutes'];
                                }
                            }
                        }
                    });
                    
                    // Restore notes
                    if (dailyData.notes) {
                        document.getElementById('daily-notes').value = dailyData.notes;
                    }
                } else {
                    console.log('No saved data for today');
                }
            } catch (error) {
                console.error('Error loading today data:', error);
            }
        }

        async function loadTodayMercy() {
            try {
                const key = `mercy:${currentDate}`;
                const result = await window.storage.get(key);
                
                if (result && result.value) {
                    const mercyData = JSON.parse(result.value);
                    
                    document.querySelectorAll('#mercy-tab input[type="checkbox"]').forEach(checkbox => {
                        const onchangeAttr = checkbox.getAttribute('onchange');
                        if (onchangeAttr) {
                            const match = onchangeAttr.match(/'([^']+)'/);
                            if (match) {
                                const work = match[1];
                                if (mercyData[work]) {
                                    checkbox.checked = true;
                                }
                            }
                        }
                    });
                    
                    document.querySelectorAll('#mercy-tab textarea').forEach(textarea => {
                        const onchangeAttr = textarea.getAttribute('onchange');
                        if (onchangeAttr) {
                            const match = onchangeAttr.match(/'([^']+)'/);
                            if (match) {
                                const work = match[1];
                                if (mercyData[work + '_notes']) {
                                    textarea.value = mercyData[work + '_notes'];
                                }
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('Error loading today mercy data:', error);
            }
        }

        // Manual PIN Reset Function
        async function resetPINManually() {
            const confirm1 = confirm(
                '‚ö†Ô∏è WARNING: This will delete ALL your data and reset the app!\n\n' +
                'This includes:\n' +
                '‚Ä¢ All daily activities\n' +
                '‚Ä¢ All confession records\n' +
                '‚Ä¢ All sin tracking\n' +
                '‚Ä¢ All works of mercy\n' +
                '‚Ä¢ Your PIN\n\n' +
                'Are you sure?'
            );
            
            if (!confirm1) return;
            
            const confirm2 = confirm('FINAL CONFIRMATION:\n\nClick OK to DELETE EVERYTHING and reset PIN setup.');
            
            if (!confirm2) return;
            
            try {
                // Clear all localStorage
                localStorage.clear();
                
                alert('‚úÖ All data cleared!\n\nThe page will now reload and show PIN setup.');
                
                // Reload the page
                window.location.reload();
            } catch (error) {
                alert('‚ùå Error: ' + error.message);
            }
        }

        // Storage Testing Function
        async function testStorage() {
            const debugDiv = document.getElementById('storage-debug');
            try {
                currentDate = getCurrentDate();
                debugDiv.innerHTML = 'Testing storage...<br>';
                
                // Test write
                const testKey = `test:${Date.now()}`;
                const testData = { test: true, timestamp: new Date().toISOString() };
                debugDiv.innerHTML += `Writing test data...<br>`;
                const writeResult = await window.storage.set(testKey, JSON.stringify(testData));
                debugDiv.innerHTML += `Write result: ${JSON.stringify(writeResult)}<br><br>`;
                
                // Test read
                debugDiv.innerHTML += `Reading test data...<br>`;
                const readResult = await window.storage.get(testKey);
                debugDiv.innerHTML += `Read result: ${JSON.stringify(readResult)}<br><br>`;
                
                // Check today's data
                const todayKey = `daily:${currentDate}`;
                debugDiv.innerHTML += `Current date: ${currentDate}<br>`;
                debugDiv.innerHTML += `Today's key: ${todayKey}<br>`;
                
                try {
                    const todayData = await window.storage.get(todayKey);
                    if (todayData && todayData.value) {
                        debugDiv.innerHTML += `Today's data exists:<br>${JSON.stringify(JSON.parse(todayData.value), null, 2)}<br><br>`;
                    } else {
                        debugDiv.innerHTML += `No data saved for today yet<br><br>`;
                    }
                } catch (e) {
                    debugDiv.innerHTML += `No data saved for today yet<br><br>`;
                }
                
                // List all stored keys
                const allDaily = await window.storage.list('daily:');
                debugDiv.innerHTML += `All daily activity dates:<br>`;
                if (allDaily && allDaily.keys && allDaily.keys.length > 0) {
                    allDaily.keys.forEach(key => {
                        debugDiv.innerHTML += `- ${key}<br>`;
                    });
                } else {
                    debugDiv.innerHTML += `No daily activities stored yet<br>`;
                }
                
                // Check confessions
                const allConfessions = await window.storage.list('confession:');
                debugDiv.innerHTML += `<br>All confession records:<br>`;
                if (allConfessions && allConfessions.keys && allConfessions.keys.length > 0) {
                    debugDiv.innerHTML += `Found ${allConfessions.keys.length} confession(s)<br>`;
                    allConfessions.keys.forEach(key => {
                        debugDiv.innerHTML += `- ${key}<br>`;
                    });
                } else {
                    debugDiv.innerHTML += `No confessions recorded yet<br>`;
                }
                
                // Check works of mercy
                const allMercy = await window.storage.list('mercy:');
                debugDiv.innerHTML += `<br>All works of mercy dates:<br>`;
                if (allMercy && allMercy.keys && allMercy.keys.length > 0) {
                    allMercy.keys.forEach(key => {
                        debugDiv.innerHTML += `- ${key}<br>`;
                    });
                } else {
                    debugDiv.innerHTML += `No works of mercy stored yet<br>`;
                }
                
                debugDiv.innerHTML += `<br>‚úÖ Storage is working!`;
                
            } catch (error) {
                debugDiv.innerHTML += `<br>‚ùå ERROR: ${error.message}<br>${error.stack}`;
                console.error('Storage test error:', error);
            }
        }

        // Sin Tracking Functions
        const commonSins = [
            { id: 'pride', label: 'Pride', category: 'capital' },
            { id: 'greed', label: 'Greed/Avarice', category: 'capital' },
            { id: 'lust', label: 'Lust (Impure Thoughts)', category: 'capital' },
            { id: 'anger', label: 'Anger/Wrath', category: 'capital' },
            { id: 'gluttony', label: 'Gluttony', category: 'capital' },
            { id: 'envy', label: 'Envy', category: 'capital' },
            { id: 'sloth', label: 'Sloth (Spiritual Laziness)', category: 'capital' },
            { id: 'lying', label: 'Lying', category: 'neighbor' },
            { id: 'gossip', label: 'Gossip', category: 'neighbor' },
            { id: 'pornography', label: 'Pornography', category: 'purity' },
            { id: 'masturbation', label: 'Masturbation', category: 'purity' },
            { id: 'missing-mass', label: 'Missing Mass', category: 'god' },
        ];

        async function loadSinTrackers() {
            document.getElementById('tracker-date').textContent = new Date().toLocaleDateString('en-US', { 
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
            });
            
            const trackerList = document.getElementById('sin-tracker-list');
            let html = '';
            
            // Get last confession date
            let lastConfessionDate = null;
            try {
                const confessionResult = await window.storage.list('confession:');
                if (confessionResult && confessionResult.keys && confessionResult.keys.length > 0) {
                    const lastKey = confessionResult.keys.sort().reverse()[0];
                    const confessionData = await window.storage.get(lastKey);
                    if (confessionData && confessionData.value) {
                        const data = JSON.parse(confessionData.value);
                        lastConfessionDate = new Date(data.date);
                    }
                }
            } catch (e) {
                console.log('No confession history yet');
            }
            
            // Update days since confession
            if (lastConfessionDate) {
                const daysSince = Math.floor((new Date() - lastConfessionDate) / (1000 * 60 * 60 * 24));
                document.getElementById('days-since-confession').textContent = daysSince + ' days';
                
                const nextDate = new Date(lastConfessionDate);
                nextDate.setDate(nextDate.getDate() + 30);
                document.getElementById('next-confession-date').textContent = nextDate.toLocaleDateString('en-US', { 
                    month: 'long', day: 'numeric', year: 'numeric' 
                });
            } else {
                document.getElementById('days-since-confession').textContent = 'No confession recorded yet';
                document.getElementById('next-confession-date').textContent = 'Record your first confession';
            }
            
            // Get sin counts for current period
            for (const sin of commonSins) {
                const count = await getSinCount(sin.id, lastConfessionDate);
                
                html += `
                    <div class="bg-white p-4 rounded-lg border border-gray-200">
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-semibold text-gray-800">${sin.label}</span>
                            <span class="text-2xl font-bold text-indigo-600">${count}</span>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="incrementSin('${sin.id}')" 
                                    class="flex-1 bg-red-100 text-red-700 px-3 py-2 rounded hover:bg-red-200 text-sm font-semibold">
                                + Mark Today
                            </button>
                            <button onclick="decrementSin('${sin.id}')" 
                                    class="bg-gray-100 text-gray-700 px-3 py-2 rounded hover:bg-gray-200 text-sm">
                                ‚àí
                            </button>
                        </div>
                    </div>
                `;
            }
            
            trackerList.innerHTML = html;
            await updateSinSummary();
        }

        async function getSinCount(sinId, sinceDate) {
            try {
                const key = `sin-tracker:${sinId}`;
                const result = await window.storage.get(key);
                
                if (!result || !result.value) return 0;
                
                const data = JSON.parse(result.value);
                let count = 0;
                
                // Count occurrences since last confession
                for (const [date, occurrences] of Object.entries(data)) {
                    const entryDate = new Date(date);
                    if (!sinceDate || entryDate > sinceDate) {
                        count += occurrences;
                    }
                }
                
                return count;
            } catch (e) {
                return 0;
            }
        }

        async function incrementSin(sinId) {
            try {
                currentDate = getCurrentDate();
                const key = `sin-tracker:${sinId}`;
                let data = {};
                
                try {
                    const result = await window.storage.get(key);
                    if (result && result.value) {
                        data = JSON.parse(result.value);
                    }
                } catch (e) {
                    // New tracker
                }
                
                // Increment count for today
                if (!data[currentDate]) {
                    data[currentDate] = 0;
                }
                data[currentDate]++;
                
                await window.storage.set(key, JSON.stringify(data));
                await loadSinTrackers();
            } catch (error) {
                console.error('Error tracking sin:', error);
            }
        }

        async function decrementSin(sinId) {
            try {
                currentDate = getCurrentDate();
                const key = `sin-tracker:${sinId}`;
                
                const result = await window.storage.get(key);
                if (!result || !result.value) return;
                
                let data = JSON.parse(result.value);
                
                if (data[currentDate] && data[currentDate] > 0) {
                    data[currentDate]--;
                    if (data[currentDate] === 0) {
                        delete data[currentDate];
                    }
                    await window.storage.set(key, JSON.stringify(data));
                    await loadSinTrackers();
                }
            } catch (error) {
                console.error('Error decrementing sin:', error);
            }
        }

        async function updateSinSummary() {
            const summaryDiv = document.getElementById('sin-summary');
            let html = '<p class="text-sm text-gray-600 mb-3">Since last confession:</p>';
            
            // Get last confession date
            let lastConfessionDate = null;
            try {
                const confessionResult = await window.storage.list('confession:');
                if (confessionResult && confessionResult.keys && confessionResult.keys.length > 0) {
                    const lastKey = confessionResult.keys.sort().reverse()[0];
                    const confessionData = await window.storage.get(lastKey);
                    if (confessionData && confessionData.value) {
                        const data = JSON.parse(confessionData.value);
                        lastConfessionDate = new Date(data.date);
                    }
                }
            } catch (e) {}
            
            for (const sin of commonSins) {
                const count = await getSinCount(sin.id, lastConfessionDate);
                if (count > 0) {
                    html += `
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-700">${sin.label}</span>
                            <span class="font-semibold text-red-600">${count}√ó</span>
                        </div>
                    `;
                }
            }
            
            if (!html.includes('√ó')) {
                html += '<p class="text-sm text-green-600 italic">No sins tracked this period üôè</p>';
            }
            
            summaryDiv.innerHTML = html;
        }

        function showAllSinTrackers() {
            alert('More sin trackers coming soon! For now, use the confession examination to record all sins.');
        }

        // Data Management Functions
        async function exportData() {
            const statusDiv = document.getElementById('export-status');
            try {
                statusDiv.innerHTML = '<span class="text-blue-600">üì¶ Gathering your data...</span>';
                
                // Ask if user wants encryption
                const shouldEncrypt = confirm(
                    'üîí Would you like to password-protect this backup?\n\n' +
                    'Protected backups require a password to import.\n\n' +
                    'Click OK to set a password\n' +
                    'Click Cancel for unprotected backup'
                );
                
                let password = null;
                if (shouldEncrypt) {
                    password = prompt('Enter a password for this backup:');
                    if (!password) {
                        statusDiv.innerHTML = '<span class="text-red-600">‚ùå Export cancelled</span>';
                        return;
                    }
                    const confirmPassword = prompt('Confirm password:');
                    if (password !== confirmPassword) {
                        statusDiv.innerHTML = '<span class="text-red-600">‚ùå Passwords do not match</span>';
                        return;
                    }
                }
                
                // Collect all data
                const exportData = {
                    exportDate: new Date().toISOString(),
                    appVersion: '3.3',
                    encrypted: shouldEncrypt,
                    data: {
                        daily: {},
                        confessions: {},
                        mercy: {},
                        sinTracking: {}
                    }
                };
                
                // Get all daily activities
                const dailyResult = await window.storage.list('daily:');
                if (dailyResult && dailyResult.keys) {
                    for (const key of dailyResult.keys) {
                        const result = await window.storage.get(key);
                        if (result && result.value) {
                            exportData.data.daily[key] = result.value;
                        }
                    }
                }
                
                // Get all confessions
                const confessionResult = await window.storage.list('confession:');
                if (confessionResult && confessionResult.keys) {
                    for (const key of confessionResult.keys) {
                        const result = await window.storage.get(key);
                        if (result && result.value) {
                            exportData.data.confessions[key] = result.value;
                        }
                    }
                }
                
                // Get all works of mercy
                const mercyResult = await window.storage.list('mercy:');
                if (mercyResult && mercyResult.keys) {
                    for (const key of mercyResult.keys) {
                        const result = await window.storage.get(key);
                        if (result && result.value) {
                            exportData.data.mercy[key] = result.value;
                        }
                    }
                }
                
                // Get all sin tracking data
                const sinResult = await window.storage.list('sin-tracker:');
                if (sinResult && sinResult.keys) {
                    for (const key of sinResult.keys) {
                        const result = await window.storage.get(key);
                        if (result && result.value) {
                            exportData.data.sinTracking[key] = result.value;
                        }
                    }
                }
                
                let dataStr = JSON.stringify(exportData, null, 2);
                
                // Encrypt if requested
                if (shouldEncrypt && password) {
                    statusDiv.innerHTML = '<span class="text-blue-600">üîê Encrypting backup...</span>';
                    dataStr = await encrypt(dataStr, password);
                }
                
                // Create download
                const dataBlob = new Blob([dataStr], { type: shouldEncrypt ? 'application/octet-stream' : 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                
                const link = document.createElement('a');
                link.href = url;
                const dateStr = new Date().toISOString().split('T')[0];
                link.download = `sanctification-backup-${dateStr}${shouldEncrypt ? '.encrypted' : '.json'}`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                const dailyCount = Object.keys(exportData.data.daily).length;
                const confessionCount = Object.keys(exportData.data.confessions).length;
                const mercyCount = Object.keys(exportData.data.mercy).length;
                const sinCount = Object.keys(exportData.data.sinTracking).length;
                
                statusDiv.innerHTML = `<span class="text-green-600">‚úÖ Backup downloaded successfully!<br>
                    ${shouldEncrypt ? 'üîí Password-protected backup<br>' : ''}
                    Included: ${dailyCount} days of activities, ${confessionCount} confession(s), ${mercyCount} days of mercy, ${sinCount} sin trackers</span>`;
                
            } catch (error) {
                console.error('Export error:', error);
                statusDiv.innerHTML = `<span class="text-red-600">‚ùå Error: ${error.message}</span>`;
            }
        }

        async function importData() {
            const statusDiv = document.getElementById('import-status');
            const fileInput = document.getElementById('import-file');
            
            if (!fileInput.files || fileInput.files.length === 0) {
                statusDiv.innerHTML = '<span class="text-red-600">‚ùå Please select a backup file first</span>';
                return;
            }
            
            try {
                statusDiv.innerHTML = '<span class="text-blue-600">üì• Reading backup file...</span>';
                
                const file = fileInput.files[0];
                let fileText = await file.text();
                let importData;
                
                // Check if file is encrypted
                const isEncrypted = file.name.endsWith('.encrypted') || fileText.length < 1000 && !fileText.startsWith('{');
                
                if (isEncrypted) {
                    const password = prompt('Enter the password for this backup:');
                    if (!password) {
                        statusDiv.innerHTML = '<span class="text-red-600">‚ùå Import cancelled</span>';
                        return;
                    }
                    
                    statusDiv.innerHTML = '<span class="text-blue-600">üîì Decrypting backup...</span>';
                    try {
                        fileText = await decrypt(fileText, password);
                    } catch (e) {
                        statusDiv.innerHTML = '<span class="text-red-600">‚ùå Wrong password or corrupted file</span>';
                        return;
                    }
                }
                
                importData = JSON.parse(fileText);
                
                // Validate file structure
                if (!importData.data) {
                    throw new Error('Invalid backup file format');
                }
                
                statusDiv.innerHTML = '<span class="text-blue-600">üíæ Importing data...</span>';
                
                let imported = { daily: 0, confessions: 0, mercy: 0, sinTracking: 0 };
                
                // Import daily activities
                if (importData.data.daily) {
                    for (const [key, value] of Object.entries(importData.data.daily)) {
                        await window.storage.set(key, value);
                        imported.daily++;
                    }
                }
                
                // Import confessions
                if (importData.data.confessions) {
                    for (const [key, value] of Object.entries(importData.data.confessions)) {
                        await window.storage.set(key, value);
                        imported.confessions++;
                    }
                }
                
                // Import works of mercy
                if (importData.data.mercy) {
                    for (const [key, value] of Object.entries(importData.data.mercy)) {
                        await window.storage.set(key, value);
                        imported.mercy++;
                    }
                }
                
                // Import sin tracking
                if (importData.data.sinTracking) {
                    for (const [key, value] of Object.entries(importData.data.sinTracking)) {
                        await window.storage.set(key, value);
                        imported.sinTracking++;
                    }
                }
                
                statusDiv.innerHTML = `<span class="text-green-600">‚úÖ Import successful!<br>
                    ${isEncrypted ? 'üîì Decrypted backup<br>' : ''}
                    Imported: ${imported.daily} days of activities, ${imported.confessions} confession(s), ${imported.mercy} days of mercy, ${imported.sinTracking} sin trackers<br>
                    <em>Refresh the page to see imported data</em></span>`;
                
                // Reload current tab data
                await loadTodayData();
                await loadTodayMercy();
                
            } catch (error) {
                console.error('Import error:', error);
                statusDiv.innerHTML = `<span class="text-red-600">‚ùå Error: ${error.message}<br>
                    Make sure you selected a valid backup file from this app.</span>`;
            }
        }

        async function clearAllData() {
            const confirmation = confirm(
                '‚ö†Ô∏è WARNING: This will permanently delete ALL your spiritual tracking data!\n\n' +
                'This includes:\n' +
                '‚Ä¢ All daily activities\n' +
                '‚Ä¢ All confession records\n' +
                '‚Ä¢ All works of mercy\n\n' +
                'This action CANNOT be undone!\n\n' +
                'Are you absolutely sure you want to continue?'
            );
            
            if (!confirmation) {
                return;
            }
            
            const doubleCheck = confirm(
                'FINAL CONFIRMATION:\n\n' +
                'Are you REALLY sure you want to delete everything?\n\n' +
                'Click OK to delete all data.\n' +
                'Click Cancel to keep your data safe.'
            );
            
            if (!doubleCheck) {
                return;
            }
            
            const statusDiv = document.getElementById('clear-status');
            
            try {
                statusDiv.innerHTML = '<span class="text-blue-600">üóëÔ∏è Deleting all data...</span>';
                
                let deleted = { daily: 0, confessions: 0, mercy: 0 };
                
                // Delete all daily activities
                const dailyResult = await window.storage.list('daily:');
                if (dailyResult && dailyResult.keys) {
                    for (const key of dailyResult.keys) {
                        await window.storage.delete(key);
                        deleted.daily++;
                    }
                }
                
                // Delete all confessions
                const confessionResult = await window.storage.list('confession:');
                if (confessionResult && confessionResult.keys) {
                    for (const key of confessionResult.keys) {
                        await window.storage.delete(key);
                        deleted.confessions++;
                    }
                }
                
                // Delete all works of mercy
                const mercyResult = await window.storage.list('mercy:');
                if (mercyResult && mercyResult.keys) {
                    for (const key of mercyResult.keys) {
                        await window.storage.delete(key);
                        deleted.mercy++;
                    }
                }
                
                statusDiv.innerHTML = `<span class="text-green-600">‚úÖ All data deleted.<br>
                    Deleted: ${deleted.daily} days of activities, ${deleted.confessions} confession(s), ${deleted.mercy} days of works of mercy<br>
                    <em>Refresh the page to reset the interface</em></span>`;
                
                // Clear the current UI
                document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
                document.querySelectorAll('input[type="number"]').forEach(input => input.value = '');
                document.querySelectorAll('textarea').forEach(ta => ta.value = '');
                
            } catch (error) {
                console.error('Clear data error:', error);
                statusDiv.innerHTML = `<span class="text-red-600">‚ùå Error: ${error.message}</span>`;
            }
        }

        // Initialize on load
        window.addEventListener('load', async () => {
            console.log('App starting - no PIN security');
            
            // Load data immediately
            await loadTodayData();
            await loadTodayMercy();
            await loadLastConfession();
            
            // Register service worker for PWA
            if ('serviceWorker' in navigator) {
                try {
                    await navigator.serviceWorker.register('sw.js');
                    console.log('Service worker registered');
                } catch (error) {
                    console.log('Service worker registration failed:', error);
                }
            }
        });
    </script>
</body>
</html>